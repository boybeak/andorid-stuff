## åº”ç”¨å¯åŠ¨æ—¶å‡ºç°é»‘å±/ç™½å±ï¼Œå¦‚ä½•ä¼˜åŒ–ï¼Ÿ

åº”ç”¨å¯åŠ¨æ—¶å‡ºç°é»‘å±æˆ–ç™½å±ï¼Œé€šå¸¸æ˜¯ç”±äºä»¥ä¸‹å‡ ä¸ªåŸå› å¯¼è‡´çš„ï¼š  

- **åº”ç”¨è¿›ç¨‹åˆ›å»ºåˆ° UI æ¸²æŸ“ä¹‹é—´çš„æ—¶é—´è¿‡é•¿**ï¼ˆä¾‹å¦‚åˆå§‹åŒ–æ“ä½œè€—æ—¶è¾ƒé•¿ï¼‰ã€‚  
- **æ²¡æœ‰æŒ‡å®šåˆé€‚çš„å¯åŠ¨èƒŒæ™¯**ï¼Œå¯¼è‡´ç³»ç»Ÿé»˜è®¤æ˜¾ç¤ºé»‘å±æˆ–ç™½å±ã€‚  
- **å†·å¯åŠ¨ï¼ˆCold Startï¼‰æ—¶é—´è¿‡é•¿**ï¼Œå³åº”ç”¨ä»é›¶å¯åŠ¨çš„è¿‡ç¨‹è¾ƒæ…¢ã€‚  

## **ä¼˜åŒ–æ–¹æ¡ˆ**

### **1. è®¾ç½®åˆé€‚çš„å¯åŠ¨èƒŒæ™¯**
Android å…è®¸åœ¨ `theme` ä¸­æŒ‡å®š `windowBackground`ï¼Œè¿™æ ·å¯ä»¥åœ¨ Activity å¯åŠ¨å‰æä¾›ä¸€ä¸ªè¿‡æ¸¡ç•Œé¢ï¼Œé¿å…é»‘å±æˆ–ç™½å±é—®é¢˜ã€‚

#### **ï¼ˆ1ï¼‰åœ¨ `res/values/styles.xml` æ·»åŠ  windowBackground**
```xml
<style name="AppTheme" parent="Theme.Material3.DayNight">
    <!-- è®¾ç½®å¯åŠ¨æ—¶çš„èƒŒæ™¯ -->
    <item name="android:windowBackground">@drawable/splash_screen</item>
</style>
```
ç„¶ååœ¨ `res/drawable/splash_screen.xml` åˆ›å»ºä¸€ä¸ª `LayerDrawable`ï¼š
```xml
<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
    <item android:drawable="@color/primary" />
    <item>
        <bitmap
            android:gravity="center"
            android:src="@mipmap/ic_launcher_foreground" />
    </item>
</layer-list>
```
è¿™æ ·ï¼Œåº”ç”¨å¯åŠ¨æ—¶è‡³å°‘ä¼šæœ‰ä¸€ä¸ªèƒŒæ™¯é¢œè‰²ï¼Œå¹¶ä¸”å¯ä»¥æ˜¾ç¤º LOGOï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

#### **ï¼ˆ2ï¼‰åœ¨ `AndroidManifest.xml` é…ç½®å¯åŠ¨ä¸»é¢˜**
```xml
<activity
    android:name=".MainActivity"
    android:theme="@style/SplashTheme">
```
ç„¶ååœ¨ `styles.xml` ä¸­å®šä¹‰ `SplashTheme`ï¼Œå¹¶åœ¨ `onCreate` æ–¹æ³•ä¸­åˆ‡æ¢å› `AppTheme`ï¼š
```xml
<style name="SplashTheme" parent="Theme.Material3.DayNight">
    <item name="android:windowBackground">@drawable/splash_screen</item>
</style>
```
```kotlin
class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        setTheme(R.style.AppTheme) // åˆ‡æ¢åˆ°ä¸»ä¸»é¢˜
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
    }
}
```

---

### **2. å‡å°‘ Application çš„åˆå§‹åŒ–æ—¶é—´**
`Application` çš„åˆå§‹åŒ–é€»è¾‘å¦‚æœè¿‡äºå¤æ‚ï¼Œå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨å¯åŠ¨ç¼“æ…¢ã€‚ä¼˜åŒ–æ–¹å¼åŒ…æ‹¬ï¼š

- **é¿å…åœ¨ Application ä¸­è¿›è¡Œ I/O æ“ä½œ**ï¼ˆå¦‚æ•°æ®åº“ã€ç½‘ç»œè¯·æ±‚ï¼‰ã€‚  
- **ä½¿ç”¨æ‡’åŠ è½½**ï¼Œå°†ä¸å¿…è¦çš„åˆå§‹åŒ–æ¨è¿Ÿåˆ°çœŸæ­£éœ€è¦çš„æ—¶å€™ã€‚  
- **é‡‡ç”¨ `WorkManager` å¤„ç†è€—æ—¶ä»»åŠ¡**ï¼Œè€Œä¸æ˜¯åœ¨ `Application` ä¸­ç›´æ¥æ‰§è¡Œã€‚  
- **ä½¿ç”¨ `App Startup`ï¼ˆJetpack åº“ï¼‰ä¼˜åŒ–åˆå§‹åŒ–è¿‡ç¨‹**ã€‚  

---

### **3. é‡‡ç”¨ `SplashScreen` APIï¼ˆAndroid 12+ æ¨èï¼‰**
å¦‚æœä½ çš„åº”ç”¨é€‚é…äº† Android 12 åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨å®˜æ–¹çš„ `SplashScreen` APIï¼š
```kotlin
class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        installSplashScreen() // å¯ç”¨å®˜æ–¹å¯åŠ¨å±
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
    }
}
```
è¿™ä¸ª API å…è®¸ä½ æ§åˆ¶å¯åŠ¨ç”»é¢çš„æ˜¾ç¤ºæ—¶é—´ï¼Œé¿å…é»‘å±ã€‚

---

### **4. ä½¿ç”¨ `ViewStub` å»¶è¿ŸåŠ è½½éå¿…è¦è§†å›¾**
`ViewStub` å…è®¸åœ¨éœ€è¦æ—¶æ‰åŠ è½½è§†å›¾ï¼Œå‡å°‘ `setContentView` æ—¶çš„è´Ÿæ‹…ã€‚ä¾‹å¦‚ï¼š
```xml
<ViewStub
    android:id="@+id/large_layout"
    android:layout="@layout/large_ui"
    android:layout_width="match_parent"
    android:layout_height="wrap_content" />
```
åœ¨ä»£ç ä¸­ï¼š
```kotlin
findViewById<ViewStub>(R.id.large_layout)?.inflate()
```
è¿™æ ·å¯ä»¥å‡å°‘åˆå§‹å¸ƒå±€çš„æ¸²æŸ“æ—¶é—´ã€‚

---

### **5. é¿å… UI é˜»å¡**
- **å‡å°‘ `onCreate` å’Œ `onResume` çš„é˜»å¡**ã€‚  
- **ä½¿ç”¨ `Coroutines` æˆ– `Handler` å»¶è¿ŸåŠ è½½æ•°æ®**ï¼Œä¾‹å¦‚ï¼š
  ```kotlin
  lifecycleScope.launch {
      delay(500) // æ¨¡æ‹Ÿå¼‚æ­¥åŠ è½½
      loadData()
  }
  ```

---

## **æ€»ç»“**
- **ä½¿ç”¨ `windowBackground` è®©å¯åŠ¨ç”»é¢æ›´æµç•…**ã€‚  
- **å‡å°‘ Application çš„åˆå§‹åŒ–æ—¶é—´**ï¼Œé¿å…é˜»å¡ UI çº¿ç¨‹ã€‚  
- **ä½¿ç”¨ `SplashScreen API` æå‡ä½“éªŒï¼ˆAndroid 12+ï¼‰**ã€‚  
- **ä½¿ç”¨ `ViewStub` æˆ– `lazy load` å»¶è¿ŸåŠ è½½éå¿…è¦ UI**ã€‚  
- **ä¼˜åŒ– `onCreate`ï¼Œé¿å…ä¸»çº¿ç¨‹æ‰§è¡Œè¿‡é‡æ“ä½œ**ã€‚  

è¿™æ ·å¯ä»¥æœ‰æ•ˆå‡å°‘é»‘å±/ç™½å±é—®é¢˜ï¼Œæé«˜å¯åŠ¨é€Ÿåº¦ï¼ ğŸš€




## çº¿ä¸Šå¶ç°çš„Crashå¦‚ä½•æ•è·å’Œå®šä½ï¼Ÿï¼ˆå¦‚Breakpadã€è‡ªå®šä¹‰CrashHandlerï¼‰

çº¿ä¸Šå¶ç°çš„ Crash å¾€å¾€éš¾ä»¥å¤ç°ï¼Œå› æ­¤éœ€è¦æœ‰æ•ˆçš„ **Crash æ•è·ã€æ—¥å¿—è®°å½•ã€ä¸Šä¼ å’Œåˆ†æ** æ–¹æ³•ã€‚ä»¥ä¸‹æ˜¯ä¸»æµæ–¹æ¡ˆï¼š

---

## **1. ä½¿ç”¨ Breakpadï¼ˆC++/NDK å´©æºƒæ•è·ï¼‰**
å¦‚æœä½ çš„åº”ç”¨ä½¿ç”¨äº† **NDKï¼ˆC++ ä»£ç ï¼‰**ï¼Œå¯ä»¥ä½¿ç”¨ Google çš„ **Breakpad** æ¥æ•è· Native å´©æºƒã€‚  

### **ï¼ˆ1ï¼‰Breakpad ä»‹ç»**
Breakpad æ˜¯ Google å¼€æºçš„è·¨å¹³å° Crash å¤„ç†åº“ï¼Œæ”¯æŒ **Androidã€Windowsã€Linuxã€Mac**ï¼Œèƒ½æ•è· **Native å´©æºƒï¼ˆSIGSEGVã€SIGABRTï¼‰** å¹¶ç”Ÿæˆ `minidump` ä¾›åˆ†æã€‚

### **ï¼ˆ2ï¼‰Breakpad ä½¿ç”¨æ­¥éª¤**
1. **é›†æˆ Breakpad**
   - åœ¨ `CMakeLists.txt` ä¸­å¼•å…¥ï¼š
     ```cmake
     add_subdirectory(breakpad)
     include_directories(breakpad/src)
     ```
   - åœ¨ C++ ä»£ç ä¸­åˆå§‹åŒ–ï¼š
     ```cpp
     static google_breakpad::ExceptionHandler* exceptionHandler;
     exceptionHandler = new google_breakpad::ExceptionHandler(
         dumpPath, nullptr, dumpCallback, nullptr, true, -1);
     ```
   
2. **æ•è·å´©æºƒå¹¶ç”Ÿæˆ `minidump`**
   - `dumpCallback` ç”¨äºå¤„ç†å´©æºƒï¼š
     ```cpp
     bool dumpCallback(const google_breakpad::MinidumpDescriptor& descriptor,
                       void* context,
                       bool succeeded) {
         LOGD("Crash dump created at: %s", descriptor.path());
         return succeeded;
     }
     ```

3. **ä¸Šä¼  `minidump` è¿›è¡Œåˆ†æ**
   - åœ¨å´©æºƒåï¼Œä¸‹ä¸€æ¬¡å¯åŠ¨æ—¶ä¸Šä¼ ï¼š
     ```java
     File dumpFile = new File(getApplicationContext().getFilesDir(), "crash.dmp");
     uploadToServer(dumpFile);
     ```
   - åˆ†æ `minidump` å¯ä½¿ç”¨ `addr2line` æˆ– `breakpad/tools/minidump_stackwalk`ã€‚

---

## **2. Java å±‚ Crash æ•è·ï¼ˆè‡ªå®šä¹‰ `UncaughtExceptionHandler`ï¼‰**
å¯¹äº **Java/Kotlin** ä»£ç å´©æºƒï¼Œå¯ä»¥é€šè¿‡ `Thread.setDefaultUncaughtExceptionHandler()` æ•è·å¼‚å¸¸å¹¶ä¿å­˜æ—¥å¿—ã€‚

### **ï¼ˆ1ï¼‰å®ç°è‡ªå®šä¹‰ `CrashHandler`**
```java
public class CrashHandler implements Thread.UncaughtExceptionHandler {
    private static CrashHandler instance = new CrashHandler();
    private Thread.UncaughtExceptionHandler defaultHandler;

    private CrashHandler() {}

    public static CrashHandler getInstance() {
        return instance;
    }

    public void init() {
        defaultHandler = Thread.getDefaultUncaughtExceptionHandler();
        Thread.setDefaultUncaughtExceptionHandler(this);
    }

    @Override
    public void uncaughtException(Thread t, Throwable e) {
        // è®°å½•å´©æºƒæ—¥å¿—
        saveCrashLog(e);

        // ä¸Šä¼ å´©æºƒä¿¡æ¯
        uploadCrashLog();

        // äº¤ç»™ç³»ç»Ÿé»˜è®¤å¤„ç†ï¼ˆé‡å¯åº”ç”¨æˆ–é€€å‡ºï¼‰
        if (defaultHandler != null) {
            defaultHandler.uncaughtException(t, e);
        }
    }

    private void saveCrashLog(Throwable e) {
        try {
            File file = new File("/sdcard/crash_log.txt");
            FileWriter writer = new FileWriter(file, true);
            writer.write(Log.getStackTraceString(e));
            writer.close();
        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    private void uploadCrashLog() {
        // å¯ç”¨ Retrofit/OkHttp ä¸Šä¼ åˆ°æœåŠ¡å™¨
    }
}
```

### **ï¼ˆ2ï¼‰åœ¨ `Application` ä¸­åˆå§‹åŒ–**
```java
public class MyApplication extends Application {
    @Override
    public void onCreate() {
        super.onCreate();
        CrashHandler.getInstance().init();
    }
}
```
è¿™æ ·ï¼Œæ‰€æœ‰ Java å±‚å¼‚å¸¸éƒ½ä¼šè¢«è®°å½•å¹¶ä¸Šä¼ ã€‚

---

## **3. ä½¿ç”¨ `Firebase Crashlytics`ï¼ˆæ¨èï¼‰**
Google æä¾›çš„ `Firebase Crashlytics` å¯ä»¥è‡ªåŠ¨æ•è· Java/Kotlin å’Œ Native å´©æºƒï¼Œå¹¶æä¾›è¯¦ç»†çš„åˆ†æã€‚

### **ï¼ˆ1ï¼‰é›†æˆ `Crashlytics`**
1. åœ¨ `build.gradle` ä¸­æ·»åŠ ï¼š
   ```gradle
   dependencies {
       implementation 'com.google.firebase:firebase-crashlytics:18.6.0'
       implementation 'com.google.firebase:firebase-analytics'
   }
   ```
2. åˆå§‹åŒ–ï¼š
   ```java
   public class MyApplication extends Application {
       @Override
       public void onCreate() {
           super.onCreate();
           FirebaseApp.initializeApp(this);
       }
   }
   ```

3. æ‰‹åŠ¨è®°å½•å¼‚å¸¸ï¼š
   ```java
   try {
       int result = 10 / 0;
   } catch (Exception e) {
       FirebaseCrashlytics.getInstance().recordException(e);
   }
   ```

4. åœ¨ Firebase æ§åˆ¶å°æŸ¥çœ‹å´©æºƒè¯¦æƒ…ï¼Œæ”¯æŒ **NDKã€Java/Kotlinã€å¤šçº¿ç¨‹ Crash åˆ†æ**ã€‚

---

## **4. ANRï¼ˆåº”ç”¨æ— å“åº”ï¼‰æ•è·**
ANRï¼ˆApplication Not Respondingï¼‰ä¸ä¼šè¢« `CrashHandler` ç›´æ¥æ•è·ï¼Œéœ€è¦ç›‘å¬ **`mainLooper` æ˜¯å¦é˜»å¡**ã€‚

### **ï¼ˆ1ï¼‰ä½¿ç”¨ `Choreographer` æ£€æµ‹ UI çº¿ç¨‹å¡é¡¿**
```java
Choreographer.getInstance().postFrameCallback(new Choreographer.FrameCallback() {
    long lastFrameTime = System.nanoTime();
    
    @Override
    public void doFrame(long frameTimeNanos) {
        long diffMs = (frameTimeNanos - lastFrameTime) / 1_000_000;
        if (diffMs > 500) { // å¡é¡¿è¶…è¿‡ 500ms
            Log.e("ANR DETECTED", "UI çº¿ç¨‹å¡é¡¿ï¼š" + diffMs + "ms");
        }
        lastFrameTime = frameTimeNanos;
        Choreographer.getInstance().postFrameCallback(this);
    }
});
```
**å¦‚æœ UI çº¿ç¨‹é•¿æ—¶é—´ä¸å“åº”ï¼Œè¯´æ˜å¯èƒ½å‘ç”Ÿäº† ANRï¼Œå¯ä¸ŠæŠ¥æ—¥å¿—ã€‚**

---

## **5. ä½¿ç”¨ `ptrace` æ•è· Native ANR**
å¯ä»¥ä½¿ç”¨ `ptrace` ç›‘å¬ Native è¿›ç¨‹çš„ SIGABRT ä¿¡å·ï¼š
```cpp
ptrace(PTRACE_ATTACH, pid, NULL, NULL);
```
ç„¶ååœ¨ `logcat` ä¸­æ•è· ANR å †æ ˆï¼Œåˆ†æå¡é¡¿åŸå› ã€‚

---

## **6. Crash å®šä½ä¸åˆ†æ**
æ•è·åˆ°å´©æºƒæ—¥å¿—åï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æ–¹æ³•å®šä½é—®é¢˜ï¼š

### **ï¼ˆ1ï¼‰åˆ†æ Java å´©æºƒæ—¥å¿—**
é€šå¸¸ `logcat` ä¼šæ‰“å°ç±»ä¼¼ï¼š
```
FATAL EXCEPTION: main
java.lang.NullPointerException: Attempt to invoke virtual method 'int java.lang.String.length()' on a null object reference
    at com.example.app.MainActivity.onCreate(MainActivity.java:30)
```
- `MainActivity.java:30` ç›´æ¥æŒ‡å‘å´©æºƒä»£ç ï¼Œå¯é€šè¿‡ Git å†å²æ‰¾å‡ºåŸå› ã€‚

### **ï¼ˆ2ï¼‰åˆ†æ Native å´©æºƒ**
- `SIGSEGVï¼ˆæ®µé”™è¯¯ï¼‰`ï¼šæŒ‡é’ˆè®¿é—®éæ³•å†…å­˜ï¼Œå¯ç”¨ `addr2line` è§£æï¼š
  ```sh
  addr2line -e libnative-lib.so 0x0001a2c0
  ```
  è¿™ä¼šè¾“å‡ºå¯¹åº”çš„ C++ ä»£ç ä½ç½®ã€‚

- `SIGABRT`ï¼šé€šå¸¸æ˜¯ `abort()` æˆ– `assert()` è§¦å‘ï¼Œå¯æŸ¥çœ‹ `logcat` åŠ `tombstone`ã€‚

---

## **æ€»ç»“**
| æ–¹æ¡ˆ | é€‚ç”¨èŒƒå›´ | ä¼˜åŠ¿ | ç¼ºç‚¹ |
|------|------|------|------|
| **Breakpad** | NDKï¼ˆC++ å´©æºƒï¼‰ | é€‚ç”¨äº Native å´©æºƒï¼Œç”Ÿæˆ `minidump` | éœ€è¦è§£æ `minidump` |
| **UncaughtExceptionHandler** | Java/Kotlin | ç®€å•æ˜“ç”¨ï¼Œå¯è‡ªå®šä¹‰å¤„ç† | ä¸èƒ½æ•è· NDK å´©æºƒ |
| **Firebase Crashlytics** | Java/Kotlin/NDK | æ˜“ç”¨ï¼Œæ”¯æŒ ANR å’Œ Native å´©æºƒåˆ†æ | éœ€è”ç½‘ä¸Šä¼  |
| **Choreographer** | ANR ç›‘æ§ | ç›‘æµ‹ UI å¡é¡¿ | ä¸èƒ½è‡ªåŠ¨æ¢å¤ |

å¯¹äº **çº¿ä¸Šå¶å‘ Crash**ï¼Œæ¨èï¼š
âœ… **Javaï¼š`Crashlytics` + è‡ªå®šä¹‰ `CrashHandler`**  
âœ… **Nativeï¼š`Breakpad`**  
âœ… **ANRï¼š`Choreographer`**  

è¿™æ ·å¯ä»¥æœ€å¤§é™åº¦æ•è·å¹¶åˆ†æå´©æºƒï¼Œæé«˜åº”ç”¨ç¨³å®šæ€§ï¼ ğŸš€