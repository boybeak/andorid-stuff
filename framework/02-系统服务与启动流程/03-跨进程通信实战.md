## ä½¿ç”¨Binderè¿æ¥ç³»ç»ŸæœåŠ¡ï¼ˆå¦‚è·å–ç³»ç»ŸæœåŠ¡å®ä¾‹ï¼‰

åœ¨ Android ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `Binder` æœºåˆ¶è¿æ¥ç³»ç»ŸæœåŠ¡å¹¶è·å–æœåŠ¡å®ä¾‹ã€‚ä»¥ä¸‹æ˜¯è·å–ç³»ç»ŸæœåŠ¡çš„å‡ ç§æ–¹å¼ï¼š

---

### 1. **é€šè¿‡ `Context.getSystemService()` è·å–ç³»ç»ŸæœåŠ¡**ï¼ˆæ¨èï¼‰
å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç³»ç»ŸæœåŠ¡å¯ä»¥é€šè¿‡ `Context.getSystemService()` ç›´æ¥è·å–ï¼š
```java
AudioManager audioManager = (AudioManager) getSystemService(Context.AUDIO_SERVICE);
```
ä½†æŸäº›éšè—æˆ–ç³»ç»Ÿçº§æœåŠ¡æ— æ³•é€šè¿‡ `getSystemService()` è·å–ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ `Binder` ç›´æ¥è¿æ¥ã€‚

---

### 2. **é€šè¿‡ `ServiceManager.getService()` è·å– Binder æœåŠ¡**
`ServiceManager.getService()` å…è®¸ç›´æ¥è·å–ç³»ç»ŸæœåŠ¡çš„ `IBinder`ï¼Œç„¶åè½¬æ¢ä¸ºç›®æ ‡ AIDL æ¥å£ã€‚

#### ç¤ºä¾‹ï¼šè·å– `AudioService`
```java
import android.os.IBinder;
import android.os.ServiceManager;
import android.media.IAudioService;

public class MainActivity extends AppCompatActivity {
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        try {
            IBinder binder = ServiceManager.getService("audio");
            IAudioService audioService = IAudioService.Stub.asInterface(binder);
            int volume = audioService.getStreamVolume(AudioManager.STREAM_MUSIC);
            Log.d("AudioService", "Music Stream Volume: " + volume);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```
âš ï¸ `ServiceManager.getService()` æ˜¯ **éšè— API**ï¼Œåœ¨ Android 9ï¼ˆAPI 28ï¼‰åéœ€è¦ **ç»•è¿‡éšè— API é™åˆ¶**ï¼ˆå¦‚ä½¿ç”¨ `reflection` æˆ– `@Keep`ï¼‰ã€‚

---

### 3. **é€šè¿‡ `IBinder` ç›´æ¥é€šä¿¡**
å¦‚æœä½ çŸ¥é“æŸä¸ªç³»ç»ŸæœåŠ¡çš„ `IBinder`ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨å…¶ `transact()` æ–¹æ³•ï¼š
```java
IBinder binder = ServiceManager.getService("activity");
Parcel data = Parcel.obtain();
Parcel reply = Parcel.obtain();
try {
    binder.transact(1, data, reply, 0);
    reply.readException();
} catch (RemoteException e) {
    e.printStackTrace();
} finally {
    data.recycle();
    reply.recycle();
}
```
ä½†è¿™æ ·åšéœ€è¦äº†è§£ç³»ç»ŸæœåŠ¡çš„ `AIDL` æ¥å£çš„ `transact` ç¼–å·ï¼Œé€šå¸¸ä¸æ¨èã€‚

---

### 4. **é€šè¿‡ `SystemServiceRegistry`ï¼ˆAndroid å†…éƒ¨æœºåˆ¶ï¼‰**
æŸäº›ç³»ç»ŸæœåŠ¡é€šè¿‡ `SystemServiceRegistry` æ³¨å†Œï¼Œå¯ä»¥ä½¿ç”¨ `SystemServiceRegistry.getSystemService()` è·å–ï¼š
```java
ConnectivityManager cm = SystemServiceRegistry.getSystemService(Context.CONNECTIVITY_SERVICE, ConnectivityManager.class);
```
ä½† `SystemServiceRegistry` ä¸»è¦ç”¨äºç³»ç»Ÿå†…éƒ¨ï¼Œä¸é€‚ç”¨äºæ™®é€šåº”ç”¨ã€‚

---

## ç»“è®º
- **æ¨è**ï¼šèƒ½ç”¨ `getSystemService()` å°±ç”¨å®ƒï¼Œå…¼å®¹æ€§æœ€å¥½ã€‚
- **è¿›é˜¶**ï¼šæ— æ³•è·å–æ—¶ï¼Œå°è¯• `ServiceManager.getService()`ï¼Œä½†éœ€è¦æƒé™æˆ– rootã€‚
- **ä½çº§ API**ï¼š`Binder.transact()` ç›´æ¥è°ƒç”¨è¾ƒåº•å±‚ï¼Œé€šå¸¸ä»…ç”¨äºè‡ªå®šä¹‰ `AIDL` äº¤äº’ã€‚

ä½ å…·ä½“æƒ³è·å–å“ªä¸ªç³»ç»ŸæœåŠ¡ï¼Ÿ

å¯¹äºæ™®é€šåº”ç”¨æ¥è¯´ï¼Œåªæœ‰ç¬¬ä¸€ç§å¯ç”¨ã€‚



## åˆ†æ`ActivityManagerNative`ä¸`ActivityManagerProxy`æºç  

åœ¨ Android æ—©æœŸç‰ˆæœ¬ï¼ˆAPI 25 åŠä»¥å‰ï¼‰ï¼Œ`ActivityManagerNative` å’Œ `ActivityManagerProxy` ä¸»è¦ç”¨äº `Binder` è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ï¼Œç”¨äºåº”ç”¨ä¸ `ActivityManagerService`ï¼ˆAMSï¼‰äº¤äº’ã€‚  

**ä½†åœ¨ Android 26ï¼ˆOreoï¼‰åï¼Œ`ActivityManagerNative` è¢«ç§»é™¤ï¼Œä»£ç è¢«æ•´åˆè¿› `IActivityManager` å’Œ `ActivityManager` ä¸­ã€‚**

---

# ğŸ“Œ **1. `ActivityManagerNative` åˆ†æ**
`ActivityManagerNative` ä½œä¸º `IActivityManager.Stub` çš„å®ç°ï¼Œä¸»è¦ç”¨äºï¼š
- **æœåŠ¡ç«¯**ï¼šç®¡ç† `ActivityManagerService`ï¼ˆAMSï¼‰
- **å®¢æˆ·ç«¯**ï¼šæä¾› `asInterface()`ï¼Œè®©åº”ç”¨è®¿é—® `ActivityManagerService`

## **ğŸ“œ æ—©æœŸæºç ï¼ˆAndroid 7.1ï¼‰**
ğŸ“‚ **è·¯å¾„**ï¼š`frameworks/base/core/java/android/app/ActivityManagerNative.java`
```java
public abstract class ActivityManagerNative extends IActivityManager.Stub {
    static public IActivityManager getDefault() {
        return gDefault.get();
    }

    private static final Singleton<IActivityManager> gDefault = 
        new Singleton<IActivityManager>() {
            protected IActivityManager create() {
                IBinder b = ServiceManager.getService("activity");
                if (b != null) {
                    return IActivityManager.Stub.asInterface(b);
                }
                return null;
            }
        };
}
```

### **ğŸ” å…³é”®ç‚¹**
1. **ç»§æ‰¿ `IActivityManager.Stub`**ï¼Œç”¨äºæœåŠ¡ç«¯å®ç°ï¼ˆAMSï¼‰ã€‚
2. **`getDefault()` è·å– `ActivityManagerService`**ï¼š
   - é€šè¿‡ `ServiceManager.getService("activity")` è·å– `IBinder`
   - é€šè¿‡ `IActivityManager.Stub.asInterface(binder)` è½¬æ¢ä¸º `IActivityManager` ä»£ç†å¯¹è±¡

---

# ğŸ“Œ **2. `ActivityManagerProxy` åˆ†æ**
ğŸ“‚ **è·¯å¾„**ï¼š`frameworks/base/core/java/android/app/ActivityManagerProxy.java`

`ActivityManagerProxy` è´Ÿè´£ä¸ `ActivityManagerService`ï¼ˆAMSï¼‰é€šä¿¡ï¼Œå®ƒæ˜¯ `IActivityManager.Stub.Proxy` çš„å…·ä½“å®ç°ã€‚

## **ğŸ“œ æ—©æœŸæºç ï¼ˆAndroid 7.1ï¼‰**
```java
class ActivityManagerProxy implements IActivityManager {
    private IBinder mRemote;

    ActivityManagerProxy(IBinder remote) {
        mRemote = remote;
    }

    public int getMemoryClass() throws RemoteException {
        Parcel data = Parcel.obtain();
        Parcel reply = Parcel.obtain();
        int result;
        try {
            data.writeInterfaceToken(IActivityManager.descriptor);
            mRemote.transact(TRANSACTION_getMemoryClass, data, reply, 0);
            reply.readException();
            result = reply.readInt();
        } finally {
            reply.recycle();
            data.recycle();
        }
        return result;
    }
}
```

### **ğŸ” å…³é”®ç‚¹**
1. **`ActivityManagerProxy` æ˜¯ `IActivityManager.Stub.Proxy` çš„å®ç°**ã€‚
2. **å°è£… `Binder` è°ƒç”¨**ï¼š
   - `mRemote.transact(TRANSACTION_getMemoryClass, data, reply, 0)` å‘é€è¯·æ±‚
   - `reply.readException();` è¯»å–è¿”å›å€¼
3. **ä¸ `ActivityManagerService`ï¼ˆAMSï¼‰è¿›è¡Œ IPC**ã€‚

---

# ğŸ“Œ **3. `ActivityManagerNative` è¢«ç§»é™¤åçš„å˜åŒ–ï¼ˆAndroid 26+ï¼‰**
- **Android 26ï¼ˆOreoï¼‰ç§»é™¤äº† `ActivityManagerNative`**ã€‚
- **`IActivityManager.Stub` ç›´æ¥å¤„ç† `Binder` äº¤äº’**ï¼š
  - **åŸ `ActivityManagerNative.getDefault()` é€»è¾‘è¢«ç§»åŠ¨åˆ° `ActivityManager.getService()`**
- **å®¢æˆ·ç«¯æ”¹ç”¨ `ActivityManager.getService()` è·å– `IActivityManager` å®ä¾‹**

## **ğŸ“œ Android 13+ ä»£ç **
ğŸ“‚ **è·¯å¾„**ï¼š`frameworks/base/core/java/android/app/ActivityManager.java`
```java
public class ActivityManager {
    private static IActivityManager getService() {
        return IActivityManager.Stub.asInterface(
            ServiceManager.getService(Context.ACTIVITY_SERVICE));
    }
}
```
âœ… **ç°åœ¨ç›´æ¥è°ƒç”¨ `ActivityManager.getService()`** ä»£æ›¿ `ActivityManagerNative.getDefault()`ã€‚

---

# ğŸ“Œ **æ€»ç»“**
| ç»„ä»¶ | ä½œç”¨ | Android 7.1 | Android 8.0+ |
|------|------|------------|--------------|
| `ActivityManagerNative` | `AMS` ä»£ç†ï¼Œè·å– `IActivityManager` | å­˜åœ¨ | è¢«ç§»é™¤ |
| `ActivityManagerProxy` | `IActivityManager` çš„ `Binder` ä»£ç† | å­˜åœ¨ | ä»ç„¶å­˜åœ¨ |
| `ActivityManager` | æä¾› `AMS` è®¿é—®æ¥å£ | è°ƒç”¨ `ActivityManagerNative.getDefault()` | è°ƒç”¨ `ActivityManager.getService()` |

âœ… **ç°åœ¨åº”ç”¨åº”ä½¿ç”¨ `ActivityManager.getService()`ï¼Œä¸å†éœ€è¦ `ActivityManagerNative`ï¼**