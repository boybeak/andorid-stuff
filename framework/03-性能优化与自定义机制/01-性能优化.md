## LeakCanaryåŸç†

## LeakCanary åŸç†è¯¦è§£

LeakCanary æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ Android å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·ï¼Œå®ƒé€šè¿‡ç›‘æ§å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå¹¶åœ¨å‘ç°å¯èƒ½çš„å†…å­˜æ³„æ¼æ—¶æä¾›è¯¦ç»†çš„åˆ†ææŠ¥å‘Šã€‚å®ƒçš„æ ¸å¿ƒåŸç†ä¸»è¦åŒ…æ‹¬ **å¼•ç”¨é˜Ÿåˆ—ï¼ˆReferenceQueueï¼‰ã€GC è§¦å‘ã€Heap Dump åˆ†æ** ç­‰æŠ€æœ¯ã€‚ä¸‹é¢æˆ‘ä»¬è¯¦ç»†è§£æ LeakCanary çš„åŸç†ã€‚

---

## **1. LeakCanary æ£€æµ‹å†…å­˜æ³„æ¼çš„æ ¸å¿ƒæµç¨‹**

### **ï¼ˆ1ï¼‰ç›‘å¬ç›®æ ‡å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ**
LeakCanary é€šè¿‡ **å¼±å¼•ç”¨ï¼ˆWeakReferenceï¼‰** æ¥ç›‘å¬ç‰¹å®šå¯¹è±¡ï¼ˆé€šå¸¸æ˜¯ Activityã€Fragmentã€è‡ªå®šä¹‰ View ç­‰ï¼‰çš„ç”Ÿå‘½å‘¨æœŸã€‚å½“å¯¹è±¡è¢«åƒåœ¾å›æ”¶ï¼ˆGCï¼‰æ—¶ï¼ŒWeakReference ä¹Ÿä¼šè¢«æ¸…é™¤ã€‚å¦‚æœå¯¹è±¡åº”è¯¥è¢«å›æ”¶ä½†è¿Ÿè¿Ÿæ²¡æœ‰è¢«å›æ”¶ï¼Œå°±å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ã€‚

### **ï¼ˆ2ï¼‰ä½¿ç”¨ ReferenceQueue æ£€æµ‹å¯¹è±¡æ˜¯å¦è¢«å›æ”¶**
LeakCanary åˆ›å»ºäº†ä¸€ä¸ª **ReferenceQueue**ï¼ˆå¼•ç”¨é˜Ÿåˆ—ï¼‰ï¼Œå¹¶å°†éœ€è¦ç›‘æµ‹çš„å¯¹è±¡å°è£…åˆ°ä¸€ä¸ª `KeyedWeakReference` ä¸­ï¼ŒåŒæ—¶å…³è”è¯¥å¼•ç”¨é˜Ÿåˆ—ã€‚å¦‚æœå¯¹è±¡è¢«å›æ”¶ï¼Œ`KeyedWeakReference` ä¼šè¿›å…¥ `ReferenceQueue`ï¼Œå¦åˆ™åœ¨ä¸€å®šæ—¶é—´åä»æœªè¿›å…¥é˜Ÿåˆ—ï¼Œå°±å¯èƒ½å­˜åœ¨æ³„æ¼ã€‚

### **ï¼ˆ3ï¼‰å¼ºåˆ¶è§¦å‘ GC**
ä¸ºäº†æ›´å¿«æ£€æµ‹æ³„æ¼ï¼ŒLeakCanary åœ¨åˆé€‚çš„æ—¶æœºæ‰‹åŠ¨è§¦å‘ **GC**ï¼Œè®©ç³»ç»Ÿå°½é‡å›æ”¶ä¸å†ä½¿ç”¨çš„å¯¹è±¡ã€‚å¦‚æœ GC åç›®æ ‡å¯¹è±¡ä»æœªè¿›å…¥ `ReferenceQueue`ï¼Œè¯´æ˜å¯¹è±¡è¿˜å­˜æ´»ï¼Œå¯èƒ½å­˜åœ¨æ³„æ¼ã€‚

### **ï¼ˆ4ï¼‰Dump å†…å­˜å¿«ç…§**
å¦‚æœå¯¹è±¡é•¿æ—¶é—´æ— æ³•è¢«å›æ”¶ï¼ŒLeakCanary ä¼šè§¦å‘ **Heap Dump**ï¼ˆå †å†…å­˜è½¬å‚¨ï¼‰ï¼Œå³ç”Ÿæˆå½“å‰åº”ç”¨çš„å †å†…å­˜å¿«ç…§ã€‚

### **ï¼ˆ5ï¼‰è§£æ Heap Dump**
LeakCanary ä½¿ç”¨ **Shark**ï¼ˆä¸€ä¸ªåŸºäº HAHA åº“çš„è½»é‡çº§ heap åˆ†æåº“ï¼‰è§£æ Heap Dump æ–‡ä»¶ï¼Œå¹¶æ‰¾åˆ°å¯¼è‡´å¯¹è±¡æ— æ³•è¢«é‡Šæ”¾çš„ **GC Root å¼•ç”¨é“¾**ï¼Œæœ€ç»ˆç¡®å®šæ³„æ¼è·¯å¾„ã€‚

### **ï¼ˆ6ï¼‰ç”Ÿæˆè¯¦ç»†çš„æ³„æ¼æŠ¥å‘Š**
LeakCanary é€šè¿‡åˆ†æ GC Root åˆ°æ³„æ¼å¯¹è±¡çš„å¼•ç”¨é“¾ï¼Œç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„æŠ¥å‘Šï¼Œå±•ç¤ºå¯¼è‡´æ³„æ¼çš„ä»£ç ä½ç½®å’Œç›¸å…³å¼•ç”¨å…³ç³»ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½é—®é¢˜ã€‚

---

## **2. LeakCanary çš„è¯¦ç»†å·¥ä½œæµç¨‹**

### **â‘  ç›‘å¬å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ**
LeakCanary ä¸»è¦ç›‘æµ‹ `Activity`ã€`Fragment`ã€`View` ä»¥åŠæ‰‹åŠ¨æ·»åŠ çš„å¯¹è±¡ï¼š
- ç›‘å¬ `ActivityLifecycleCallbacks`ï¼Œåœ¨ `onDestroy()` æ—¶æ£€æµ‹ Activity æ˜¯å¦è¢«æ­£å¸¸å›æ”¶ã€‚
- ç›‘å¬ `FragmentLifecycleCallbacks`ï¼Œæ£€æµ‹ Fragment æ˜¯å¦è¢«æ­£å¸¸å›æ”¶ã€‚
- ç›‘å¬ `View`ï¼Œæ£€æµ‹è‡ªå®šä¹‰ View æ˜¯å¦è¢«æ­£ç¡®é”€æ¯ã€‚

å½“ `onDestroy()` è§¦å‘æ—¶ï¼ŒLeakCanary ä¼šåˆ›å»ºä¸€ä¸ª `KeyedWeakReference`ï¼Œç”¨æ¥è¿½è¸ªå¯¹è±¡æ˜¯å¦è¢«å›æ”¶ï¼š

```java
// åˆ›å»º WeakReference ç›‘å¬å¯¹è±¡
KeyedWeakReference reference = new KeyedWeakReference(
    watchedObject, key, name, queue
);
```

å…¶ä¸­ï¼š
- `watchedObject` æ˜¯éœ€è¦ç›‘æ§çš„å¯¹è±¡ï¼ˆå¦‚ Activityï¼‰ã€‚
- `queue` æ˜¯ `ReferenceQueue`ï¼Œç”¨äºæ£€æµ‹å¯¹è±¡æ˜¯å¦è¢«å›æ”¶ã€‚
- `key` æ˜¯å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒå¯¹è±¡ã€‚

---

### **â‘¡ æ£€æµ‹å¯¹è±¡æ˜¯å¦è¢«å›æ”¶**
LeakCanary åœ¨ä¸€æ®µæ—¶é—´åæ£€æŸ¥ `ReferenceQueue` æ˜¯å¦åŒ…å« `KeyedWeakReference`ï¼š
- **å¦‚æœå¯¹è±¡è¢« GC**ï¼Œé‚£ä¹ˆ `KeyedWeakReference` ä¼šè¢«åŠ å…¥ `ReferenceQueue`ï¼Œè¯´æ˜å¯¹è±¡å·²è¢«å›æ”¶ï¼Œä¸å­˜åœ¨æ³„æ¼ã€‚
- **å¦‚æœå¯¹è±¡æœªè¢« GC**ï¼ŒLeakCanary è®¤ä¸ºå¯¹è±¡å¯èƒ½æ³„æ¼ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥æ£€æµ‹ã€‚

---

### **â‘¢ è§¦å‘ GC**
å¦‚æœå¯¹è±¡æœªè¿›å…¥ `ReferenceQueue`ï¼ŒLeakCanary ä¼šå°è¯•è§¦å‘ GCï¼Œä»¥ç¡®ä¿åƒåœ¾å›æ”¶çš„æ‰§è¡Œï¼š

```java
System.gc();
System.runFinalization();
```

è¿™ä¼šè¯·æ±‚ JVM è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå¹¶æ‰§è¡Œ `finalize()` æ–¹æ³•ï¼Œä»¥ç¡®ä¿æ— ç”¨å¯¹è±¡èƒ½è¢«å›æ”¶ã€‚

---

### **â‘£ Dump å†…å­˜å¿«ç…§**
å¦‚æœå¤šæ¬¡ GC åå¯¹è±¡ä»æœªè¢«å›æ”¶ï¼ŒLeakCanary ä¼šè§¦å‘ **Heap Dump**ï¼Œå°†å½“å‰è¿›ç¨‹çš„å †å†…å­˜ä¿å­˜ä¸º `.hprof` æ–‡ä»¶ã€‚

```java
HeapDump heapDump = heapDumper.dumpHeap();
```

Heap Dump è®°å½•äº† Java å †ä¸­æ‰€æœ‰å¯¹è±¡åŠå…¶å¼•ç”¨å…³ç³»ï¼Œç”¨äºåç»­åˆ†æã€‚

---

### **â‘¤ è§£æ Heap Dump**
LeakCanary ä½¿ç”¨ **Shark** åº“è§£æ `.hprof` æ–‡ä»¶ï¼Œæ‰¾åˆ°æ³„æ¼å¯¹è±¡çš„ **GC Root** å¼•ç”¨è·¯å¾„ã€‚Shark é€šè¿‡éå†å¯¹è±¡å¼•ç”¨å…³ç³»ï¼ŒæŸ¥æ‰¾å¯¼è‡´å¯¹è±¡æ— æ³•å›æ”¶çš„å…³é”®å¼•ç”¨é“¾ã€‚

å¸¸è§çš„æ³„æ¼åŸå› ï¼š
- **é™æ€å˜é‡æŒæœ‰å®ä¾‹**ï¼ˆå¦‚ `static Activity activity`ï¼‰
- **åŒ¿åå†…éƒ¨ç±»æŒæœ‰å¤–éƒ¨ç±»å¼•ç”¨**
- **Handlerã€Runnable å¯¼è‡´çš„å†…å­˜æ³„æ¼**
- **æœªæ³¨é”€çš„ç›‘å¬å™¨ï¼ˆListenerï¼‰**
- **ç³»ç»Ÿ API çš„ Bugï¼ˆå¦‚ InputMethodManagerï¼‰**

---

### **â‘¥ ç”Ÿæˆæ³„æ¼æŠ¥å‘Š**
LeakCanary è§£æå‡ºå®Œæ•´çš„æ³„æ¼è·¯å¾„ï¼Œå¹¶ç”Ÿæˆç±»ä¼¼ä»¥ä¸‹æ ¼å¼çš„æ—¥å¿—ï¼š

```
â”¬â”€â”€â”€
â”‚ GC Root: System class
â”‚
â”œâ”€ android.app.ActivityThread instance
â”‚    Leaking: NO (it's a global reference)
â”‚
â”œâ”€ MainActivity instance
â”‚    Leaking: YES (Activity is destroyed but not garbage collected)
â”‚
â””â”€ anonymous subclass of Handler
     Leaking: YES (Retains reference to destroyed Activity)
```

è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼š
- `MainActivity` å·²ç» `destroyed` ä½†ä»ç„¶å­˜åœ¨å¼•ç”¨ï¼Œå¯¼è‡´æ³„æ¼ã€‚
- è¯¥æ³„æ¼æ˜¯ç”±äºåŒ¿å `Handler` æŒæœ‰ `Activity` å¼•ç”¨å¯¼è‡´çš„ã€‚

---

## **3. å¦‚ä½•é¿å…å¸¸è§çš„å†…å­˜æ³„æ¼**
LeakCanary åªæ˜¯ä¸€ä¸ªæ£€æµ‹å·¥å…·ï¼Œè¦å½»åº•è§£å†³æ³„æ¼é—®é¢˜ï¼Œå¼€å‘è€…éœ€è¦é‡‡å–ä»¥ä¸‹æªæ–½ï¼š

âœ… **é¿å…é™æ€å˜é‡æŒæœ‰ Context**
```java
public class MyClass {
    private static Context sContext; // å¯èƒ½å¯¼è‡´æ³„æ¼

    public static void init(Context context) {
        sContext = context.getApplicationContext(); // é¿å… Activity æ³„æ¼
    }
}
```

âœ… **é¿å… Handler å†…å­˜æ³„æ¼**
```java
static class MyHandler extends Handler {
    private final WeakReference<Activity> mActivityRef;

    MyHandler(Activity activity) {
        mActivityRef = new WeakReference<>(activity);
    }

    @Override
    public void handleMessage(Message msg) {
        Activity activity = mActivityRef.get();
        if (activity != null) {
            // æ‰§è¡Œ UI æ›´æ–°
        }
    }
}
```

âœ… **åŠæ—¶ç§»é™¤ç›‘å¬å™¨**
```java
@Override
protected void onDestroy() {
    super.onDestroy();
    someView.removeOnAttachStateChangeListener(listener);
}
```

âœ… **é¿å…åŒ¿åå†…éƒ¨ç±»æŒæœ‰ Activity**
```java
private static class MyRunnable implements Runnable {
    private final WeakReference<Activity> mActivityRef;

    MyRunnable(Activity activity) {
        mActivityRef = new WeakReference<>(activity);
    }

    @Override
    public void run() {
        Activity activity = mActivityRef.get();
        if (activity != null) {
            // æ‰§è¡Œä»»åŠ¡
        }
    }
}
```

---

## **æ€»ç»“**
1. LeakCanary é€šè¿‡ `WeakReference` å’Œ `ReferenceQueue` ç›‘æµ‹å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€‚
2. è§¦å‘ GCï¼Œæ£€æŸ¥å¯¹è±¡æ˜¯å¦è¢«æ­£å¸¸å›æ”¶ã€‚
3. å¦‚æœå¯¹è±¡é•¿æ—¶é—´æœªè¢«å›æ”¶ï¼ŒDump å†…å­˜å¿«ç…§ (`.hprof`) å¹¶è¿›è¡Œåˆ†æã€‚
4. è§£ææ³„æ¼è·¯å¾„ï¼Œç”Ÿæˆè¯¦ç»†æŠ¥å‘Šï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿå®šä½æ³„æ¼åŸå› ã€‚
5. é¢„é˜²å†…å­˜æ³„æ¼çš„å…³é”®æ˜¯é¿å…é•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ï¼ˆå¦‚é™æ€å˜é‡ã€Handlerï¼‰æŒæœ‰çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ï¼ˆå¦‚ Activityï¼‰ã€‚

é€šè¿‡ LeakCanaryï¼Œå¼€å‘è€…å¯ä»¥é«˜æ•ˆå®šä½å¹¶ä¿®å¤å†…å­˜æ³„æ¼é—®é¢˜ï¼Œä»è€Œæå‡åº”ç”¨çš„ç¨³å®šæ€§å’Œæ€§èƒ½ã€‚ ğŸš€



## Choreographerä¸VSyncä¿¡å·ã€è¿‡åº¦ç»˜åˆ¶æ£€æµ‹

## **Choreographerã€VSync ä¿¡å· ä¸ è¿‡åº¦ç»˜åˆ¶æ£€æµ‹**
åœ¨ Android ä¸­ï¼Œ`Choreographer` æ˜¯ **ç®¡ç† UI åˆ·æ–°èŠ‚å¥çš„æ ¸å¿ƒç»„ä»¶**ï¼Œå®ƒä¸ VSyncï¼ˆVertical Synchronizationï¼Œå‚ç›´åŒæ­¥ï¼‰ä¿¡å·ååŒå·¥ä½œï¼Œç¡®ä¿ **åº”ç”¨çš„ UI æ¸²æŸ“ä¸å±å¹•åˆ·æ–°åŒæ­¥**ï¼Œä»è€Œå®ç°æµç•…çš„åŠ¨ç”»å’Œç»˜åˆ¶æ•ˆæœã€‚æ­¤å¤–ï¼Œ`Choreographer` ä¹Ÿèƒ½å¸®åŠ©æ£€æµ‹ **è¿‡åº¦ç»˜åˆ¶**ï¼Œä¼˜åŒ– UI æ€§èƒ½ã€‚  
---
## **1. Choreographer æ˜¯ä»€ä¹ˆï¼Ÿ**
`Choreographer` ä¸»è¦ç”¨äº **è°ƒåº¦ UI çº¿ç¨‹ä¸Šçš„æ¸²æŸ“ä»»åŠ¡**ï¼Œå®ƒçš„ä½œç”¨åŒ…æ‹¬ï¼š
- **åŒæ­¥ UI æ¸²æŸ“åˆ° VSync ä¿¡å·**ï¼Œé¿å…ä¸å¿…è¦çš„åˆ·æ–°ã€‚
- **æ§åˆ¶åŠ¨ç”»å¸§ç‡**ï¼Œç¡®ä¿åŠ¨ç”»åœ¨æ­£ç¡®çš„æ—¶é—´ç‚¹è¿è¡Œã€‚
- **åè°ƒå¤šä¸ªç»˜åˆ¶ä»»åŠ¡ï¼ˆå¦‚ View ç»˜åˆ¶ã€åŠ¨ç”»æ›´æ–°ã€è¾“å…¥å¤„ç†ï¼‰**ï¼Œä¿è¯ UI çš„æµç•…æ€§ã€‚

> `Choreographer` åªå­˜åœ¨äº **ä¸»çº¿ç¨‹ï¼ˆUI çº¿ç¨‹ï¼‰**ï¼Œå¹¶ä¸”è´Ÿè´£åè°ƒ `ViewRootImpl` çš„ç»˜åˆ¶è°ƒåº¦ã€‚

---
## **2. VSync ä¿¡å·æ˜¯ä»€ä¹ˆï¼Ÿ**
### **ğŸ“Œ ä»€ä¹ˆæ˜¯ VSyncï¼Ÿ**
VSyncï¼ˆå‚ç›´åŒæ­¥ï¼‰æ˜¯ä¸€ç§ **ç¡¬ä»¶çº§çš„åŒæ­¥æœºåˆ¶**ï¼Œå®ƒçš„ä½œç”¨æ˜¯ **è®©åº”ç”¨çš„ç»˜åˆ¶è¿‡ç¨‹ä¸å±å¹•åˆ·æ–°é¢‘ç‡åŒ¹é…**ï¼Œé˜²æ­¢å±å¹•æ’•è£‚ï¼ˆTearingï¼‰ç°è±¡ã€‚

**å·¥ä½œæœºåˆ¶ï¼š**
1. **å±å¹•åˆ·æ–°**ï¼šç°ä»£å±å¹•æ¯ç§’åˆ·æ–° 60 æ¬¡ï¼ˆå³ **60Hz** å±å¹•ï¼Œæ¯ 16.67ms ä¸€æ¬¡ï¼‰ã€‚
2. **VSync ä¿¡å·**ï¼šæ¯æ¬¡åˆ·æ–°å±å¹•å‰ï¼Œç³»ç»Ÿä¼šå‘é€ VSync ä¿¡å·ï¼Œé€šçŸ¥åº”ç”¨ **å‡†å¤‡ä¸‹ä¸€å¸§ç”»é¢**ã€‚
3. **UI çº¿ç¨‹å“åº” VSync**ï¼šæ¥æ”¶åˆ° VSync ä¿¡å·åï¼Œ`Choreographer` å¼€å§‹æ‰§è¡Œç»˜åˆ¶æµç¨‹ï¼ŒåŒ…æ‹¬ï¼š
   - è®¡ç®—åŠ¨ç”»
   - å¤„ç†è¾“å…¥äº‹ä»¶
   - è¯·æ±‚ `View` é‡ç»˜
   - æäº¤ GPU å¤„ç†

è¿™æ ·ï¼Œæ•´ä¸ªç»˜åˆ¶è¿‡ç¨‹ä¸å±å¹•åˆ·æ–°åŒæ­¥ï¼Œç¡®ä¿ç”»é¢æµç•…ã€‚

### **ğŸ“Œ ä¸ºä»€ä¹ˆéœ€è¦ VSyncï¼Ÿ**
å¦‚æœæ²¡æœ‰ VSyncï¼Œåº”ç”¨çš„ç»˜åˆ¶æ—¶é—´æ˜¯ **ä¸ç¡®å®šçš„**ï¼Œå¯èƒ½å¯¼è‡´ï¼š
- å¸§ç‡ä¸ç¨³å®šï¼Œç”»é¢å¡é¡¿ã€‚
- ç»˜åˆ¶æ—¶æœºä¸åŒ¹é…ï¼Œå‡ºç°å±å¹•æ’•è£‚ã€‚

**VSync é€šè¿‡ç»Ÿä¸€ç»˜åˆ¶èŠ‚å¥ï¼Œä¿è¯åŠ¨ç”»å’Œ UI åˆ·æ–°ç¨³å®šåœ¨ 60FPSï¼Œé¿å…å¸§ç‡ä¸å‡ã€‚**

---
## **3. Choreographer ä¸ VSync çš„å·¥ä½œæµç¨‹**
### **ğŸ“Œ Choreographer å¦‚ä½•ç›‘å¬ VSync ä¿¡å·ï¼Ÿ**
`Choreographer` åœ¨ **UI çº¿ç¨‹** ç›‘å¬ VSync ä¿¡å·ï¼Œå¹¶åœ¨ VSync åˆ°æ¥æ—¶æ‰§è¡Œå›è°ƒã€‚  
å…¶æ ¸å¿ƒæµç¨‹å¦‚ä¸‹ï¼š

1. **åº”ç”¨è¯·æ±‚ç»˜åˆ¶ï¼ˆå¦‚ `invalidate()`ï¼‰**
   - è§¦å‘ `Choreographer.postCallback()`
   - é€šè¿‡ `Handler` å‘é€ä»»åŠ¡åˆ° **ä¸‹ä¸€å¸§ VSync**

2. **VSync åˆ°æ¥ï¼ˆç³»ç»Ÿåº•å±‚è§¦å‘ï¼‰**
   - `Choreographer` ç›‘å¬ `VSync`ï¼Œå›è°ƒ `doFrame()`
   - å¼€å§‹ UI çº¿ç¨‹çš„ **ç»˜åˆ¶æµç¨‹**

3. **æ‰§è¡Œç»˜åˆ¶æµç¨‹**
   - **åŠ¨ç”»è®¡ç®—**ï¼ˆ`ValueAnimator`ã€`ObjectAnimator`ï¼‰
   - **View æ ‘æµ‹é‡ & å¸ƒå±€**ï¼ˆ`measure() -> layout()`ï¼‰
   - **View ç»˜åˆ¶**ï¼ˆ`draw()`ï¼‰
   - **æäº¤åˆ° GPU æ¸²æŸ“**

4. **ç­‰å¾…ä¸‹ä¸€å¸§çš„ VSync**
   - **å¦‚æœç»˜åˆ¶è¶…æ—¶ï¼ˆè¶…è¿‡ 16.67msï¼‰**ï¼Œå°±ä¼šæ‰å¸§ï¼ˆFrame Dropï¼‰

### **ğŸ“Œ å…³é”®ä»£ç **
```java
Choreographer.getInstance().postFrameCallback(frameTimeNanos -> {
    // è¿™é‡Œæ‰§è¡ŒåŠ¨ç”»æ›´æ–° & ç»˜åˆ¶æ“ä½œ
    view.invalidate(); // è§¦å‘ View ç»˜åˆ¶
});
```
---
## **4. è¿‡åº¦ç»˜åˆ¶æ£€æµ‹**
### **ğŸ“Œ ä»€ä¹ˆæ˜¯è¿‡åº¦ç»˜åˆ¶ï¼Ÿ**
**è¿‡åº¦ç»˜åˆ¶ï¼ˆOverdrawï¼‰** æŒ‡çš„æ˜¯ **åŒä¸€ä¸ªåƒç´ è¢«ç»˜åˆ¶äº†å¤šæ¬¡**ï¼Œè¿™ä¼šå¯¼è‡´ï¼š
- **æ€§èƒ½ä¸‹é™**ï¼ˆæµªè´¹ GPU èµ„æºï¼‰
- **UI æ»åã€å¡é¡¿**

### **ğŸ“Œ è¿‡åº¦ç»˜åˆ¶çš„å…¸å‹åœºæ™¯**
1. **èƒŒæ™¯é‡å¤ç»˜åˆ¶**
   - **é”™è¯¯ï¼š** `Window` èƒŒæ™¯ + `ViewGroup` èƒŒæ™¯ + å­ View èƒŒæ™¯éƒ½ç»˜åˆ¶äº†ä¸åŒé¢œè‰²
   - **ä¼˜åŒ–ï¼š** å°½é‡å‡å°‘èƒŒæ™¯å±‚çº§ï¼Œæˆ–è®© `ViewGroup` é€æ˜ã€‚

2. **å±‚çº§è¿‡æ·±**
   - **é”™è¯¯ï¼š** `ConstraintLayout` åµŒå¥— `LinearLayout`ï¼ŒåˆåµŒå¥— `FrameLayout`
   - **ä¼˜åŒ–ï¼š** æ‰å¹³åŒ–å¸ƒå±€ï¼Œå‡å°‘ `View` å±‚çº§ã€‚

3. **æ— æ•ˆçš„ `invalidate()`**
   - **é”™è¯¯ï¼š** `invalidate()` åœ¨é«˜é¢‘ç‡åŠ¨ç”»ä¸­è¢«é¢‘ç¹è°ƒç”¨
   - **ä¼˜åŒ–ï¼š** ä»…åœ¨ UI å˜åŒ–æ—¶è°ƒç”¨ `invalidate()`ã€‚

---
## **5. å¦‚ä½•æ£€æµ‹è¿‡åº¦ç»˜åˆ¶ï¼Ÿ**
### **æ–¹æ³• 1ï¼šä½¿ç”¨å¼€å‘è€…é€‰é¡¹**
1. **æ‰“å¼€ Android è®¾ç½®**
2. **è¿›å…¥ â€œå¼€å‘è€…é€‰é¡¹â€**
3. **æ‰¾åˆ° â€œè°ƒè¯• GPU è¿‡åº¦ç»˜åˆ¶â€**
4. **é€‰æ‹© â€œæ˜¾ç¤ºè¿‡åº¦ç»˜åˆ¶åŒºåŸŸâ€**

**é¢œè‰²è¯´æ˜ï¼š**
- **è“è‰²ï¼ˆOverdraw Ã—1ï¼‰**ï¼šæ­£å¸¸
- **ç»¿è‰²ï¼ˆOverdraw Ã—2ï¼‰**ï¼šè½»å¾®è¿‡åº¦ç»˜åˆ¶
- **ç²‰è‰²ï¼ˆOverdraw Ã—3ï¼‰**ï¼šè¿‡åº¦ç»˜åˆ¶ä¸¥é‡
- **çº¢è‰²ï¼ˆOverdraw Ã—4ï¼‰**ï¼šä¸¥é‡å½±å“æ€§èƒ½ï¼Œéœ€ä¼˜åŒ–

### **æ–¹æ³• 2ï¼šä½¿ç”¨ `adb shell` å‘½ä»¤**
```sh
adb shell setprop debug.hwui.overdraw show
adb shell stop && adb shell start
```
è¿™ä¸ªå‘½ä»¤ç­‰æ•ˆäºåœ¨å¼€å‘è€…é€‰é¡¹ä¸­æ‰“å¼€ GPU è¿‡åº¦ç»˜åˆ¶ã€‚

### **æ–¹æ³• 3ï¼šä½¿ç”¨ GPU æ¸²æŸ“åˆ†æ**
åœ¨å¼€å‘è€…é€‰é¡¹ä¸­ï¼Œå¼€å¯ **â€œGPU å‘ˆç°æ¨¡å¼åˆ†æâ€**ï¼Œå¯ä»¥æŸ¥çœ‹ UI çº¿ç¨‹çš„ç»˜åˆ¶æ—¶é—´ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚

---
## **6. å¦‚ä½•ä¼˜åŒ–è¿‡åº¦ç»˜åˆ¶ï¼Ÿ**
âœ… **å‡å°‘èƒŒæ™¯å±‚çº§**
- **é¿å… `windowBackground` + `ViewGroup` èƒŒæ™¯é‡å¤**
- **ä½¿ç”¨ `android:windowIsTranslucent="true"` è®© Activity é€æ˜**

âœ… **å‡å°‘ `View` å±‚çº§**
- **ä½¿ç”¨ `ConstraintLayout` ä»£æ›¿ `RelativeLayout + LinearLayout`**
- **ç”¨ `merge` æ ‡ç­¾å‡å°‘ `ViewGroup` æ•°é‡**

âœ… **é¿å…æ— æ„ä¹‰çš„ `invalidate()`**
- **ä¸è¦é¢‘ç¹è°ƒç”¨ `invalidate()`**
- **åŠ¨ç”»æ—¶å°½é‡ä½¿ç”¨ `ViewPropertyAnimator`ï¼Œé¿å… `requestLayout()`**

âœ… **ä¼˜åŒ–è‡ªå®šä¹‰ View**
- **Canvas ç»˜åˆ¶æ—¶ï¼Œé¿å… `drawBitmap()` è¿‡å¤§**
- **å°½é‡å‡å°‘ `onDraw()` ä¸­çš„å¤æ‚è®¡ç®—**

---
## **7. æ€»ç»“**
| ç»„ä»¶ | ä½œç”¨ |
|------|------|
| **Choreographer** | ç›‘å¬ VSyncï¼Œè°ƒåº¦ UI ç»˜åˆ¶ |
| **VSync ä¿¡å·** | ç¡¬ä»¶åŒæ­¥å±å¹•åˆ·æ–°ï¼Œé¿å…æ’•è£‚ |
| **è¿‡åº¦ç»˜åˆ¶** | åŒä¸€åƒç´ è¢«ç»˜åˆ¶å¤šæ¬¡ï¼Œå½±å“æ€§èƒ½ |
| **ä¼˜åŒ–æ–¹æ¡ˆ** | å‡å°‘èƒŒæ™¯ã€é™ä½å±‚çº§ã€ä¼˜åŒ– `invalidate()` |

é€šè¿‡ç†è§£ **Choreographer** å’Œ **VSync** çš„å·¥ä½œåŸç†ï¼Œå¯ä»¥æ›´å¥½åœ°ä¼˜åŒ– Android UI æ¸²æŸ“ï¼Œå‡å°‘è¿‡åº¦ç»˜åˆ¶ï¼Œæå‡åº”ç”¨çš„æµç•…åº¦ï¼ ğŸš€


## ANRåŸç†ä¸å®šä½ï¼šä¸»çº¿ç¨‹é˜»å¡ã€æ–‡ä»¶IOæˆ–æ•°æ®åº“æ“ä½œä¼˜åŒ–

# **ANR åŸç†ä¸å®šä½ï¼Œä¸»çº¿ç¨‹é˜»å¡ã€æ–‡ä»¶ IO æˆ–æ•°æ®åº“æ“ä½œä¼˜åŒ–**
---

## **1. ä»€ä¹ˆæ˜¯ ANRï¼Ÿ**
### **ğŸ“Œ ANRï¼ˆApplication Not Respondingï¼Œåº”ç”¨æ— å“åº”ï¼‰**
ANR æ˜¯ Android ç³»ç»Ÿæ£€æµ‹åˆ°åº”ç”¨ **ä¸»çº¿ç¨‹é•¿æ—¶é—´æ— å“åº”** æ—¶è§¦å‘çš„é”™è¯¯ï¼Œè¡¨ç°ä¸ºï¼š
- **UI æ— æ³•æ“ä½œï¼Œç•Œé¢å¡æ­»**
- **ANR å¼¹çª—ï¼šåº”ç”¨æ— å“åº”ï¼Œæ˜¯å¦å…³é—­ï¼Ÿ**
- **Logcat æŠ¥é”™**ï¼š`ANR in <package_name>`

ANR å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿä¼š **è®°å½•åº”ç”¨çŠ¶æ€å¹¶ç”Ÿæˆ Trace æ—¥å¿—**ï¼Œç”¨äºåˆ†æé—®é¢˜ã€‚

---

## **2. ANR å‘ç”Ÿçš„æ¡ä»¶**
### **ğŸ“Œ è§¦å‘ ANR çš„ 3 ç§æƒ…å†µ**
| **ç±»å‹** | **è§¦å‘æ¡ä»¶** |
|---------|------------|
| **ä¸»çº¿ç¨‹é˜»å¡** |  ä¸»çº¿ç¨‹ 5s å†…æ— å“åº”ï¼ˆå¦‚æ­»å¾ªç¯ã€é”ç­‰å¾…ã€é•¿æ—¶é—´è®¡ç®—ï¼‰ |
| **è¾“å…¥äº‹ä»¶ï¼ˆæŒ‰é”®ã€è§¦æ‘¸ï¼‰ANR** | **5s å†…** ä¸»çº¿ç¨‹æœªå¤„ç† `Input` äº‹ä»¶ |
| **Service è¶…æ—¶** | **å‰å° Service 20s å†…ã€åå° Service 200s å†…** æ²¡æœ‰æ‰§è¡Œå®Œ |
| **Broadcast è¶…æ—¶** | **å‰å°å¹¿æ’­ 10sã€åå°å¹¿æ’­ 60s å†…** æ²¡æœ‰æ‰§è¡Œå®Œ |

> **âš ï¸ é‡ç‚¹ï¼šä¸»çº¿ç¨‹é˜»å¡ 5s æ˜¯æœ€å¸¸è§çš„ ANR åŸå› ï¼**

---

## **3. ANR çš„å·¥ä½œåŸç†**
### **ğŸ“Œ AMSï¼ˆActivityManagerServiceï¼‰ ç›‘æ§æœºåˆ¶**
ANR ç”± **ActivityManagerServiceï¼ˆAMSï¼‰** è´Ÿè´£ç›‘æµ‹ï¼š
1. è¿›ç¨‹å¯åŠ¨æ—¶ï¼ŒAMS è®°å½•ä¸»çº¿ç¨‹ï¼ˆ`ActivityThread`ï¼‰çš„ `Binder` è¿æ¥ã€‚
2. AMS é€šè¿‡ `InputDispatcher` ç›‘å¬ **ç”¨æˆ·è§¦æ‘¸ã€æŒ‰é”®äº‹ä»¶**ã€‚
3. å¦‚æœå‘ç° **5s å†…ä¸»çº¿ç¨‹æ²¡æœ‰å¤„ç† `Input` äº‹ä»¶**ï¼Œå°±ä¼šè§¦å‘ **ANR æœºåˆ¶**ï¼š
   - **å‘é€ `SIGQUIT` ä¿¡å·**
   - **Dump ä¸»çº¿ç¨‹å †æ ˆä¿¡æ¯**
   - **æ˜¾ç¤º ANR å¯¹è¯æ¡†**
   - **è®°å½•æ—¥å¿—åˆ° `/data/anr/traces.txt`**

---

## **4. ANR æ—¥å¿—åˆ†æï¼ˆtraces.txtï¼‰**
ANR å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿä¼šåœ¨ `/data/anr/traces.txt` è®°å½•ä¸»çº¿ç¨‹çš„å †æ ˆä¿¡æ¯ï¼š
```sh
adb shell cat /data/anr/traces.txt
```
æˆ–è€…
```sh
adb pull /data/anr/traces.txt
```

### **ğŸ“Œ å¦‚ä½•åˆ†æ `traces.txt`ï¼Ÿ**
ç¤ºä¾‹ï¼š
```
DALVIK THREADS (pid 12345):
"main" prio=5 tid=1 TIMED_WAIT
  at java.lang.Thread.sleep(Native Method)
  at com.example.MainActivity.longTask(MainActivity.java:42)
  at android.os.Handler.handleCallback(Handler.java:733)
```
#### **ğŸ›  å…³é”®ç‚¹**
- `main tid=1`ï¼šä¸»çº¿ç¨‹é˜»å¡
- `TIMED_WAIT`ï¼šçº¿ç¨‹æ­£åœ¨ `sleep()`
- `MainActivity.java:42`ï¼šç¬¬ 42 è¡Œ `longTask()` å¯èƒ½å¯¼è‡´ ANR

### **ğŸ“Œ å…¶ä»–å¸¸è§çš„é˜»å¡åŸå› **
| **åŸå› ** | **Log å…³é”®å­—** | **ç¤ºä¾‹** |
|---------|--------------|---------|
| **æ­»å¾ªç¯** | `RUNNABLE` | `while (true) {}` |
| **é”ç­‰å¾…** | `BLOCKED` | `synchronized` / `ReentrantLock` |
| **æ–‡ä»¶ IO** | `WAIT` | `FileInputStream.read()` |
| **æ•°æ®åº“æ…¢æŸ¥è¯¢** | `WAIT` | `Cursor.moveToNext()` |
| **ä¸»çº¿ç¨‹ç½‘ç»œè¯·æ±‚** | `WAIT` | `HttpURLConnection.connect()` |

---

## **5. å¦‚ä½•ä¼˜åŒ–ä¸»çº¿ç¨‹é˜»å¡ï¼Ÿ**
### **ï¼ˆ1ï¼‰é¿å…ä¸»çº¿ç¨‹æ‰§è¡Œè€—æ—¶ä»»åŠ¡**
âŒ **é”™è¯¯ç¤ºä¾‹**ï¼š
```java
// ç›´æ¥åœ¨ä¸»çº¿ç¨‹ sleep 5sï¼Œå¯¼è‡´ ANR
Thread.sleep(5000);
```
âœ… **ä¼˜åŒ–ï¼šä½¿ç”¨ `Handler` æˆ– `Coroutine`**
```java
new Handler(Looper.getMainLooper()).postDelayed(() -> {
    // 5s åæ‰§è¡Œä»»åŠ¡
}, 5000);
```
æˆ–ä½¿ç”¨ Kotlin Coroutineï¼š
```kotlin
GlobalScope.launch(Dispatchers.Main) {
    delay(5000)
    // æ‰§è¡Œä»»åŠ¡
}
```

---

### **ï¼ˆ2ï¼‰é¿å…ä¸»çº¿ç¨‹ç­‰å¾…é”**
**âŒ é”™è¯¯ç¤ºä¾‹**
```java
synchronized(lock) {  
    // ä¸»çº¿ç¨‹ç­‰å¾… 10sï¼Œå¯¼è‡´ ANR
    Thread.sleep(10000);  
}
```
**âœ… ä¼˜åŒ–ï¼šä½¿ç”¨ `tryLock()` æˆ– `HandlerThread`**
```java
ReentrantLock lock = new ReentrantLock();
if (lock.tryLock(2, TimeUnit.SECONDS)) {
    try {
        // å¤„ç†é€»è¾‘
    } finally {
        lock.unlock();
    }
} else {
    Log.w("Lock", "é”ç­‰å¾…è¶…æ—¶ï¼Œè·³è¿‡ä»»åŠ¡");
}
```

---

### **ï¼ˆ3ï¼‰é¿å…ä¸»çº¿ç¨‹æ‰§è¡Œæ–‡ä»¶ IO**
âŒ **é”™è¯¯ç¤ºä¾‹**ï¼ˆä¸»çº¿ç¨‹è¯»å–å¤§æ–‡ä»¶ï¼‰
```java
FileInputStream fis = new FileInputStream(new File("/sdcard/bigfile.txt"));
byte[] buffer = new byte[1024];
while (fis.read(buffer) != -1) {
    // å¤„ç†æ•°æ®
}
fis.close();
```
âœ… **ä¼˜åŒ–ï¼šä½¿ç”¨ `AsyncTask` æˆ– `Coroutine`**
```java
new Thread(() -> {
    FileInputStream fis = new FileInputStream(new File("/sdcard/bigfile.txt"));
    byte[] buffer = new byte[1024];
    while (fis.read(buffer) != -1) {
        // å¤„ç†æ•°æ®
    }
    fis.close();
}).start();
```

---

### **ï¼ˆ4ï¼‰é¿å…ä¸»çº¿ç¨‹æ‰§è¡Œæ•°æ®åº“æ“ä½œ**
âŒ **é”™è¯¯ç¤ºä¾‹**ï¼ˆä¸»çº¿ç¨‹æŸ¥è¯¢æ•°æ®åº“ï¼‰
```java
Cursor cursor = db.rawQuery("SELECT * FROM big_table", null);
while (cursor.moveToNext()) {
    // å¤„ç†æ•°æ®
}
cursor.close();
```
âœ… **ä¼˜åŒ–ï¼šä½¿ç”¨ `Room` ç»“åˆ `LiveData` æˆ– `Coroutine`**
```kotlin
// åœ¨åå°çº¿ç¨‹æŸ¥è¯¢
viewModelScope.launch(Dispatchers.IO) {
    val result = database.dao().getLargeData()
    withContext(Dispatchers.Main) {
        // æ›´æ–° UI
    }
}
```

---

### **ï¼ˆ5ï¼‰é¿å…ä¸»çº¿ç¨‹æ‰§è¡Œç½‘ç»œè¯·æ±‚**
âŒ **é”™è¯¯ç¤ºä¾‹**ï¼ˆ`HttpURLConnection` åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼‰
```java
URL url = new URL("https://example.com");
HttpURLConnection conn = (HttpURLConnection) url.openConnection();
conn.getInputStream();  // è¿™é‡Œä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼
```
âœ… **ä¼˜åŒ–ï¼šä½¿ç”¨ `OkHttp` + `Coroutine`**
```kotlin
GlobalScope.launch(Dispatchers.IO) {
    val response = OkHttpClient().newCall(Request.Builder().url("https://example.com").build()).execute()
    withContext(Dispatchers.Main) {
        // å¤„ç† UI æ›´æ–°
    }
}
```

---

## **6. æ€»ç»“**
| **ANR ç±»å‹** | **è§¦å‘æ—¶é—´** | **å¸¸è§åŸå› ** | **ä¼˜åŒ–æ–¹æ³•** |
|-------------|------------|------------|------------|
| **UI çº¿ç¨‹é˜»å¡** | 5s | `sleep()`ã€æ­»å¾ªç¯ã€é”ç­‰å¾… | `Handler`ã€`Coroutine`ã€`tryLock()` |
| **è¾“å…¥äº‹ä»¶è¶…æ—¶** | 5s | `onTouch()` æ‰§è¡Œè¿‡é•¿ | `postDelayed()`ã€å¼‚æ­¥å¤„ç† |
| **Service è¶…æ—¶** | 20sï¼ˆå‰å°ï¼‰200sï¼ˆåå°ï¼‰ | `onCreate()` æˆ– `onStartCommand()` è¿‡æ…¢ | `IntentService`ã€`WorkManager` |
| **Broadcast è¶…æ—¶** | 10sï¼ˆå‰å°ï¼‰60sï¼ˆåå°ï¼‰ | `onReceive()` å¤„ç†è¿‡é•¿ | `JobIntentService`ã€å¼‚æ­¥ä»»åŠ¡ |

é€šè¿‡åˆç†ä¼˜åŒ– **ä¸»çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€æ–‡ä»¶ IOã€æ•°æ®åº“æŸ¥è¯¢å’Œç½‘ç»œè¯·æ±‚**ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘ ANRï¼Œæå‡åº”ç”¨æµç•…æ€§ï¼ ğŸš€



## Systraceã€Perfettoã€MAT  

# **Android æ€§èƒ½åˆ†æå·¥å…·ï¼šSystraceã€Perfettoã€MAT ä½¿ç”¨æŒ‡å—**
---

## **1. Systraceï¼šç³»ç»Ÿçº§è¿½è¸ªåˆ†æå·¥å…·**
### **ğŸ“Œ ä»€ä¹ˆæ˜¯ Systraceï¼Ÿ**
Systrace æ˜¯ Android æä¾›çš„ **ç³»ç»Ÿçº§æ€§èƒ½åˆ†æå·¥å…·**ï¼Œç”¨äº **åˆ†æ UI å¡é¡¿ã€ä¸»çº¿ç¨‹é˜»å¡ã€æ‰å¸§** ç­‰é—®é¢˜ã€‚å®ƒå¯ä»¥ **æ•è· CPU è¿è¡ŒçŠ¶æ€ã€çº¿ç¨‹æ‰§è¡Œæƒ…å†µã€GPU æ¸²æŸ“ã€VSync äº‹ä»¶** ç­‰ç³»ç»Ÿçº§ä¿¡æ¯ã€‚

---

### **ğŸ’¡ Systrace ä½¿ç”¨æ­¥éª¤**
#### **ï¼ˆ1ï¼‰å®‰è£… Systrace**
Systrace æ˜¯ Android SDK **platform-tools** å†…ç½®å·¥å…·ï¼š
```sh
# æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
python3 path-to-android-sdk/platform-tools/systrace/systrace.py --help
```
å¦‚æœæ‰¾ä¸åˆ°ï¼Œå¯ä»¥åœ¨ [Android SDK Platform-Tools](https://developer.android.com/studio/releases/platform-tools) ä¸‹è½½ã€‚

#### **ï¼ˆ2ï¼‰æ‰§è¡Œ Systrace**
```sh
python3 path-to-android-sdk/platform-tools/systrace/systrace.py -o trace.html -t 10 gfx view sched freq
```
- `-o trace.html`ï¼šæŒ‡å®šè¾“å‡º HTML æ–‡ä»¶
- `-t 10`ï¼šé‡‡æ ·æ—¶é•¿ 10 ç§’
- `gfx view sched freq`ï¼šè·Ÿè¸ª **GPU æ¸²æŸ“ã€è§†å›¾ç»˜åˆ¶ã€è°ƒåº¦å™¨ã€CPU é¢‘ç‡**

#### **ï¼ˆ3ï¼‰åœ¨æµè§ˆå™¨æŸ¥çœ‹ç»“æœ**
ç”Ÿæˆçš„ `trace.html` å¯åœ¨ **Chrome æµè§ˆå™¨** æ‰“å¼€ï¼š
- `Main Thread`ï¼šæŸ¥çœ‹ UI çº¿ç¨‹æ˜¯å¦è¢«é˜»å¡
- `VSync`ï¼šæ£€æŸ¥å¸§ç‡æ˜¯å¦ç¨³å®š
- `Choreographer`ï¼šæŸ¥çœ‹ç»˜åˆ¶ä»»åŠ¡çš„æ‰§è¡Œæƒ…å†µ

---

## **2. Perfettoï¼šé«˜çº§ç³»ç»Ÿè¿½è¸ªå·¥å…·**
### **ğŸ“Œ ä»€ä¹ˆæ˜¯ Perfettoï¼Ÿ**
Perfetto æ˜¯ Android 9+ æä¾›çš„ **é«˜æ€§èƒ½ç³»ç»Ÿè¿½è¸ªå·¥å…·**ï¼Œæ›¿ä»£ Systraceï¼Œæ”¯æŒï¼š
- **ç²¾ç¡®çš„ CPU çº¿ç¨‹è·Ÿè¸ª**
- **ç”µæ± ã€ç”µæµæ¶ˆè€—åˆ†æ**
- **å†…å­˜æ³„æ¼æ£€æµ‹**
- **GPU/RenderThread æ¸²æŸ“åˆ†æ**

---

### **ğŸ’¡ Perfetto ä½¿ç”¨æ­¥éª¤**
#### **ï¼ˆ1ï¼‰å¯åŠ¨ Perfetto**
Perfetto å†…ç½®äº Android è®¾å¤‡ï¼Œå¯ä»¥ç›´æ¥åœ¨å‘½ä»¤è¡Œè¿è¡Œï¼š
```sh
adb shell perfetto -o /data/misc/perfetto-traces/trace.pftrace -t 10s \
    --txt \
    -c - <<EOF
buffers {
  size_kb: 10240
}
data_sources {
  config {
    name: "linux.process_stats"
  }
}
data_sources {
  config {
    name: "linux.ftrace"
    ftrace_config {
      ftrace_events: "sched/sched_switch"
      ftrace_events: "sched/sched_wakeup"
    }
  }
}
EOF
```
- `-o trace.pftrace`ï¼šæŒ‡å®šè¾“å‡ºæ–‡ä»¶
- `-t 10s`ï¼šé‡‡æ · 10 ç§’
- `sched_switch`ï¼šç›‘æµ‹çº¿ç¨‹åˆ‡æ¢
- `sched_wakeup`ï¼šç›‘æµ‹çº¿ç¨‹å”¤é†’

#### **ï¼ˆ2ï¼‰ä½¿ç”¨ Perfetto UI åˆ†æ**
1. **æ‰“å¼€ [Perfetto UI](https://ui.perfetto.dev)**
2. **æ‹–å…¥ trace.pftrace**
3. **æŸ¥çœ‹ CPUã€çº¿ç¨‹è°ƒåº¦ã€åº”ç”¨å¯åŠ¨æ—¶é—´**

---

## **3. MATï¼ˆMemory Analyzer Toolï¼‰ï¼šå†…å­˜æ³„æ¼åˆ†æ**
### **ğŸ“Œ ä»€ä¹ˆæ˜¯ MATï¼Ÿ**
MATï¼ˆMemory Analyzer Toolï¼‰æ˜¯ä¸€ä¸ªç”¨äº **åˆ†æ Android å†…å­˜æ³„æ¼** çš„å·¥å…·ï¼Œå¯ä»¥ä» **Heap Dump**ï¼ˆå †è½¬å‚¨ï¼‰æ–‡ä»¶ä¸­æ‰¾å‡ºï¼š
- **å†…å­˜æ³„æ¼**
- **å¤§å¯¹è±¡å ç”¨**
- **GC é¢‘ç‡**

---

### **ğŸ’¡ MAT ä½¿ç”¨æ­¥éª¤**
#### **ï¼ˆ1ï¼‰è·å– Heap Dump**
```sh
adb shell am dumpheap <package-name> /sdcard/heapdump.hprof
adb pull /sdcard/heapdump.hprof
```
> **ç¤ºä¾‹**
```sh
adb shell am dumpheap com.example.myapp /sdcard/heapdump.hprof
adb pull /sdcard/heapdump.hprof
```

#### **ï¼ˆ2ï¼‰ä½¿ç”¨ MAT åˆ†æ**
1. **ä¸‹è½½ [Eclipse MAT](https://www.eclipse.org/mat/)**
2. **æ‰“å¼€ `heapdump.hprof`**
3. **æ‰§è¡Œ Leak Suspects åˆ†æ**
   - `Histogram`ï¼šæŸ¥çœ‹å¯¹è±¡å ç”¨å†…å­˜æƒ…å†µ
   - `Dominator Tree`ï¼šæ‰¾å‡ºæœ€å¤§å¯¹è±¡
   - `Path to GC Roots`ï¼šåˆ†æå¯¹è±¡æ˜¯å¦å¯è¢«å›æ”¶

---

## **4. ä»€ä¹ˆæ—¶å€™ç”¨å“ªç§å·¥å…·ï¼Ÿ**
| **å·¥å…·** | **ç”¨é€”** | **é€‚ç”¨åœºæ™¯** |
|---------|--------|------------|
| **Systrace** | UI çº¿ç¨‹ã€æ‰å¸§ã€å¡é¡¿åˆ†æ | é€‚ç”¨äº **æ¸²æŸ“ä¼˜åŒ–**ï¼ˆVSyncã€Choreographerï¼‰ |
| **Perfetto** | CPUã€GPUã€ç³»ç»Ÿçº§åˆ†æ | é€‚ç”¨äº **ç³»ç»Ÿæ€§èƒ½è°ƒä¼˜ã€çº¿ç¨‹è°ƒåº¦ä¼˜åŒ–** |
| **MAT** | å†…å­˜æ³„æ¼ã€å¯¹è±¡åˆ†æ | é€‚ç”¨äº **å†…å­˜æ³„æ¼åˆ†æã€OOM æ’æŸ¥** |

è¿™äº›å·¥å…·é…åˆä½¿ç”¨ï¼Œå¯ä»¥ **å…¨é¢ä¼˜åŒ– Android åº”ç”¨çš„æ€§èƒ½** ğŸš€