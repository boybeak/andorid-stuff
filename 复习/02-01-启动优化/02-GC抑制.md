## 应用启动阶段GC抑制

在Android应用启动阶段抑制垃圾回收（GC）策略是优化应用启动速度和性能的重要手段之一。以下是几种常见的抑制GC策略：


1.增大GC阈值

• 原理：通过增大GC的触发阈值，延迟GC的触发时间，从而减少启动阶段的GC次数。

• 实现方法：

• 在Android 10及更高版本中，系统已经通过调整并发GC阈值和`totalMemory`为最大值来抑制GC。可以通过类似的方式，手动调整堆内存的阈值参数，例如`concurrent_start_bytes`和`max_allowed_footprint`。

• 在应用启动时，通过JNI调用修改ART虚拟机的堆内存参数。例如，将`concurrent_start_bytes`设置为堆内存大小的一半，从而延迟并发GC的触发。

• 优点：简单易实现，对启动速度提升明显。

• 缺点：需要根据设备和应用的实际情况调整参数，否则可能导致内存不足。


2.延迟GC任务的执行

• 原理：通过hook机制，延迟或阻塞GC任务的执行，避免在启动阶段触发GC。

• 实现方法：

• Hook`RequestConcurrentGC`方法：通过JNI或hook框架（如Xposed），拦截`Heap::RequestConcurrentGC`方法的调用，延迟或阻止GC任务的提交。

• Hook`ConcurrentGCTask::Run`方法：拦截`ConcurrentGCTask`的`Run`方法，使其在启动阶段不执行或延迟执行。

• 优点：可以精确控制GC的执行时机，避免启动阶段的GC干扰。

• 缺点：需要对Android底层代码有较深的了解，且可能与系统版本兼容性较差。


3.减少内存分配

• 原理：通过优化代码，减少启动阶段的内存分配，从而降低GC触发的可能性。

• 实现方法：

• 优化对象创建：避免在启动阶段频繁创建大量对象，尽量使用对象池复用对象。

• 优化数据结构：合理选择数据结构，减少不必要的内存占用。

• 延迟初始化：将一些非必要的初始化操作延迟到应用启动后执行。

• 优点：从根本上减少GC的触发，提升应用的整体性能。

• 缺点：需要对代码进行较多的优化工作，可能需要重构部分逻辑。


4.避免显式调用GC

• 原理：避免在代码中显式调用`System.gc()`，减少不必要的GC触发。

• 实现方法：

• 检查代码，移除所有显式的`System.gc()`调用。

• 如果确实需要触发GC，可以考虑在应用启动后延迟调用。

• 优点：简单易操作，避免人为触发GC。

• 缺点：对系统自动触发的GC无法控制。


5.使用高效的内存管理策略

• 原理：通过优化内存管理策略，减少内存碎片和内存不足的情况，从而降低GC的触发频率。

• 实现方法：

• 预分配内存：在应用启动时预分配一定量的内存，减少运行时的内存分配压力。

• 使用高效的内存分配器：例如使用`jemalloc`等高效的内存分配器替代默认的内存分配器。

• 优点：可以有效减少内存碎片和内存不足的情况，提升性能。

• 缺点：需要对内存管理有较深的理解，且可能需要引入外部库。


6.利用系统提供的GC抑制机制

• 原理：利用Android系统提供的GC抑制机制，减少启动阶段的GC。

• 实现方法：

• Android 10及以上版本：系统在应用启动时会自动抑制GC 2秒，开发者可以利用这一特性，尽量在2秒内完成启动阶段的关键操作。

• 优点：无需额外开发，直接利用系统特性。

• 缺点：受限于系统版本，且2秒的时间可能不够完成所有启动操作。


总结
抑制GC策略的选择需要根据应用的具体情况和目标设备的性能来决定。通常，结合多种策略会取得更好的效果。例如，通过优化代码减少内存分配，并结合增大GC阈值和延迟GC任务的执行，可以在启动阶段有效减少GC的触发，提升应用的启动速度和性能。